<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TEE Agent KMS &mdash; Interactive Demo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', system-ui, sans-serif; }
    .act-card { transition: opacity 0.3s; }
    .act-card.disabled { opacity: 0.4; pointer-events: none; }
    .result-box { font-family: 'Menlo', 'Consolas', monospace; font-size: 0.8rem; }
    .log-entry { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: none; } }
    .badge { display: inline-block; padding: 2px 8px; border-radius: 9999px; font-size: 0.7rem; font-weight: 600; }
    .badge-active { background: #dcfce7; color: #166534; }
    .badge-rotated { background: #fef9c3; color: #854d0e; }
    .badge-denied { background: #fee2e2; color: #991b1b; }
    .badge-provider { background: #e0e7ff; color: #3730a3; }
    .badge-dstack { background: #fce7f3; color: #9d174d; }
    .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid #e5e7eb; border-top-color: #6366f1; border-radius: 50%; animation: spin 0.6s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .provider-btn { transition: all 0.15s; }
    .provider-btn.selected { ring: 2px; }
    .arch-note { border-left: 3px solid #6366f1; }
    .arch-note-dstack { border-left-color: #ec4899; }
    .flow-step { position: relative; padding-left: 2rem; }
    .flow-step::before { content: ''; position: absolute; left: 0.6rem; top: 1.75rem; bottom: -0.5rem; width: 2px; background: #374151; }
    .flow-step:last-child::before { display: none; }
    .flow-step-dot { position: absolute; left: 0.25rem; top: 0.45rem; width: 1rem; height: 1rem; border-radius: 50%; border: 2px solid #6366f1; background: #1f2937; }
    .flow-step-dot.done { background: #6366f1; }
  </style>
</head>
<body class="bg-gray-950 text-gray-100 min-h-screen">

  <!-- Header -->
  <header class="border-b border-gray-800 px-6 py-4">
    <h1 class="text-xl font-bold tracking-tight">
      <span class="text-indigo-400">TEE</span> Agent Key Management
      <span class="text-gray-500 font-normal ml-2">&mdash; Interactive Demo</span>
    </h1>
    <p class="text-gray-500 text-sm mt-1">Explore how TEE-based key management works with different providers</p>
  </header>

  <div class="flex flex-col lg:flex-row gap-6 p-6 max-w-7xl mx-auto">

    <!-- Main Column -->
    <main class="flex-1 space-y-5">

      <!-- Act 1: Boot TEE -->
      <section id="act1" class="act-card bg-gray-900 rounded-xl border border-gray-800 p-5">
        <div class="flex items-center gap-2 mb-3">
          <span class="bg-indigo-500/20 text-indigo-300 text-xs font-bold px-2 py-0.5 rounded">ACT 1</span>
          <h2 class="font-semibold">Boot TEE Runtime</h2>
        </div>
        <p class="text-gray-400 text-sm mb-4">Choose a TEE provider and boot the runtime. Both providers implement the same <code class="text-indigo-300 text-xs">ITeeRuntime</code> interface.</p>

        <!-- Provider Selection -->
        <div class="mb-4">
          <label class="text-xs text-gray-500 block mb-2">TEE Provider</label>
          <div class="flex gap-3">
            <button onclick="selectProvider('simulator')" id="provider-simulator"
              class="provider-btn flex-1 bg-gray-950 border-2 border-indigo-500 rounded-lg p-3 text-left transition hover:border-indigo-400">
              <div class="flex items-center gap-2 mb-1">
                <span class="text-indigo-400 font-semibold text-sm">Simulator</span>
                <span class="badge badge-active">Ready</span>
              </div>
              <p class="text-gray-500 text-xs">In-memory simulation. No hardware required. Perfect for development and testing.</p>
            </button>
            <button onclick="selectProvider('dstack')" id="provider-dstack"
              class="provider-btn flex-1 bg-gray-950 border-2 border-gray-700 rounded-lg p-3 text-left transition hover:border-pink-400">
              <div class="flex items-center gap-2 mb-1">
                <span class="text-pink-400 font-semibold text-sm">dstack (TDX)</span>
                <span class="badge badge-dstack">Hardware</span>
              </div>
              <p class="text-gray-500 text-xs">Phala dstack on Intel TDX. Requires dstack simulator at <code class="text-gray-400">DSTACK_ENDPOINT</code>.</p>
            </button>
          </div>
        </div>

        <button onclick="bootRuntime()" id="btn-boot" class="bg-indigo-600 hover:bg-indigo-500 text-white text-sm font-medium px-4 py-2 rounded-lg transition">
          Boot Runtime &#9654;
        </button>
        <div id="result-boot" class="mt-3 hidden result-box bg-gray-950 border border-gray-800 rounded-lg p-3 text-green-400"></div>

        <!-- Architecture Note -->
        <div id="arch-boot" class="hidden mt-4 arch-note bg-gray-950/50 rounded-r-lg p-3 text-xs text-gray-400">
        </div>
      </section>

      <!-- Act 2: Root Key -->
      <section id="act2" class="act-card disabled bg-gray-900 rounded-xl border border-gray-800 p-5">
        <div class="flex items-center gap-2 mb-3">
          <span class="bg-indigo-500/20 text-indigo-300 text-xs font-bold px-2 py-0.5 rounded">ACT 2</span>
          <h2 class="font-semibold">Initialize Root Key</h2>
        </div>
        <p class="text-gray-400 text-sm mb-4">Generate and seal the master root key inside the TEE. All agent keys are derived from this key via HKDF-SHA256.</p>
        <button onclick="initRootKey()" id="btn-init" class="bg-indigo-600 hover:bg-indigo-500 text-white text-sm font-medium px-4 py-2 rounded-lg transition">
          Initialize Root Key &#9654;
        </button>
        <div id="result-init" class="mt-3 hidden result-box bg-gray-950 border border-gray-800 rounded-lg p-3 text-green-400"></div>

        <div id="arch-init" class="hidden mt-4 arch-note bg-gray-950/50 rounded-r-lg p-3 text-xs text-gray-400">
        </div>
      </section>

      <!-- Act 3: Agent Key + Signing -->
      <section id="act3" class="act-card disabled bg-gray-900 rounded-xl border border-gray-800 p-5">
        <div class="flex items-center gap-2 mb-3">
          <span class="bg-indigo-500/20 text-indigo-300 text-xs font-bold px-2 py-0.5 rounded">ACT 3</span>
          <h2 class="font-semibold">Create Agent Key &amp; Sign</h2>
        </div>
        <p class="text-gray-400 text-sm mb-4">Derive a child key for an agent and use it to sign messages and transactions.</p>

        <!-- Create key -->
        <div class="flex gap-2 items-end mb-3">
          <div class="flex-1">
            <label class="text-xs text-gray-500 block mb-1">Agent ID</label>
            <input id="input-agentId" type="text" value="dao-agent" class="w-full bg-gray-950 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-indigo-500" />
          </div>
          <button onclick="createKey()" id="btn-createKey" class="bg-indigo-600 hover:bg-indigo-500 text-white text-sm font-medium px-4 py-2 rounded-lg transition whitespace-nowrap">
            Create Key &#9654;
          </button>
        </div>
        <div id="result-createKey" class="mb-4 hidden result-box bg-gray-950 border border-gray-800 rounded-lg p-3 text-green-400"></div>

        <!-- Sign message -->
        <div id="sign-section" class="hidden space-y-3">
          <hr class="border-gray-800" />
          <div class="flex gap-2 items-end">
            <div class="flex-1">
              <label class="text-xs text-gray-500 block mb-1">Message</label>
              <input id="input-message" type="text" value="Hello from TEE!" class="w-full bg-gray-950 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-indigo-500" />
            </div>
            <button onclick="signMessage()" class="bg-emerald-600 hover:bg-emerald-500 text-white text-sm font-medium px-4 py-2 rounded-lg transition whitespace-nowrap">
              Sign Message &#9654;
            </button>
          </div>
          <div id="result-signMsg" class="hidden result-box bg-gray-950 border border-gray-800 rounded-lg p-3 text-green-400"></div>

          <!-- Sign transaction -->
          <div class="flex gap-2 items-end">
            <div class="flex-1">
              <label class="text-xs text-gray-500 block mb-1">Value (ETH)</label>
              <input id="input-txValue" type="text" value="0.1" class="w-full bg-gray-950 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-indigo-500" />
            </div>
            <button onclick="signTransaction()" class="bg-emerald-600 hover:bg-emerald-500 text-white text-sm font-medium px-4 py-2 rounded-lg transition whitespace-nowrap">
              Sign Transaction &#9654;
            </button>
          </div>
          <div id="result-signTx" class="hidden result-box bg-gray-950 border border-gray-800 rounded-lg p-3 text-green-400"></div>
        </div>
      </section>

      <!-- Act 4: Policy -->
      <section id="act4" class="act-card disabled bg-gray-900 rounded-xl border border-gray-800 p-5">
        <div class="flex items-center gap-2 mb-3">
          <span class="bg-indigo-500/20 text-indigo-300 text-xs font-bold px-2 py-0.5 rounded">ACT 4</span>
          <h2 class="font-semibold">Policy Enforcement</h2>
        </div>
        <p class="text-gray-400 text-sm mb-4">Attach spending and caller policies, then test enforcement with allowed and denied transactions.</p>

        <div class="grid grid-cols-3 gap-2 mb-3">
          <div>
            <label class="text-xs text-gray-500 block mb-1">Allowed Caller</label>
            <input id="input-caller" type="text" value="web-demo" class="w-full bg-gray-950 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-indigo-500" />
          </div>
          <div>
            <label class="text-xs text-gray-500 block mb-1">Max ETH / Tx</label>
            <input id="input-maxTx" type="text" value="1" class="w-full bg-gray-950 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-indigo-500" />
          </div>
          <div>
            <label class="text-xs text-gray-500 block mb-1">Max ETH / Day</label>
            <input id="input-maxDay" type="text" value="5" class="w-full bg-gray-950 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-indigo-500" />
          </div>
        </div>
        <button onclick="setupPolicy()" id="btn-policy" class="bg-indigo-600 hover:bg-indigo-500 text-white text-sm font-medium px-4 py-2 rounded-lg transition">
          Setup Policy &#9654;
        </button>
        <div id="result-policy" class="mt-3 hidden result-box bg-gray-950 border border-gray-800 rounded-lg p-3 text-green-400"></div>

        <div id="policy-tests" class="hidden mt-4 space-y-2">
          <hr class="border-gray-800" />
          <p class="text-xs text-gray-500">Test policy enforcement:</p>
          <div class="flex gap-2 flex-wrap">
            <button onclick="testPolicy('0.1','web-demo')" class="bg-emerald-600 hover:bg-emerald-500 text-white text-xs font-medium px-3 py-1.5 rounded-lg transition">
              Test 0.1 ETH (allowed) &#9654;
            </button>
            <button onclick="testPolicy('2','web-demo')" class="bg-amber-600 hover:bg-amber-500 text-white text-xs font-medium px-3 py-1.5 rounded-lg transition">
              Test 2 ETH (over limit) &#9654;
            </button>
            <button onclick="testPolicy('0.1','hacker')" class="bg-red-600 hover:bg-red-500 text-white text-xs font-medium px-3 py-1.5 rounded-lg transition">
              Test Unauthorized Caller &#9654;
            </button>
          </div>
          <div id="result-policyTest" class="hidden result-box bg-gray-950 border border-gray-800 rounded-lg p-3"></div>
        </div>
      </section>

      <!-- Act 5: Attestation -->
      <section id="act5" class="act-card disabled bg-gray-900 rounded-xl border border-gray-800 p-5">
        <div class="flex items-center gap-2 mb-3">
          <span class="bg-indigo-500/20 text-indigo-300 text-xs font-bold px-2 py-0.5 rounded">ACT 5</span>
          <h2 class="font-semibold">Remote Attestation</h2>
        </div>
        <p class="text-gray-400 text-sm mb-4">Generate an attestation quote that proves the TEE identity and root key binding, then verify it.</p>

        <div class="space-y-3">
          <button onclick="generateQuote()" id="btn-quote" class="bg-indigo-600 hover:bg-indigo-500 text-white text-sm font-medium px-4 py-2 rounded-lg transition">
            Generate Quote &#9654;
          </button>
          <div id="result-quote" class="hidden result-box bg-gray-950 border border-gray-800 rounded-lg p-3 text-green-400"></div>

          <div id="verify-section" class="hidden">
            <button onclick="verifyQuote()" id="btn-verify" class="bg-emerald-600 hover:bg-emerald-500 text-white text-sm font-medium px-4 py-2 rounded-lg transition">
              Verify Quote &#9654;
            </button>
            <div id="result-verify" class="mt-2 hidden result-box bg-gray-950 border border-gray-800 rounded-lg p-3"></div>
          </div>
        </div>

        <div id="arch-attest" class="hidden mt-4 arch-note bg-gray-950/50 rounded-r-lg p-3 text-xs text-gray-400">
        </div>
      </section>

      <!-- Act 6: Key Rotation -->
      <section id="act6" class="act-card disabled bg-gray-900 rounded-xl border border-gray-800 p-5">
        <div class="flex items-center gap-2 mb-3">
          <span class="bg-indigo-500/20 text-indigo-300 text-xs font-bold px-2 py-0.5 rounded">ACT 6</span>
          <h2 class="font-semibold">Key Rotation</h2>
        </div>
        <p class="text-gray-400 text-sm mb-4">Rotate the agent key to a new epoch. The old key is marked as rotated and a new derived key takes its place.</p>
        <button onclick="rotateKey()" id="btn-rotate" class="bg-indigo-600 hover:bg-indigo-500 text-white text-sm font-medium px-4 py-2 rounded-lg transition">
          Rotate Key &#9654;
        </button>
        <div id="result-rotate" class="mt-3 hidden result-box bg-gray-950 border border-gray-800 rounded-lg p-3 text-green-400"></div>
      </section>

    </main>

    <!-- Sidebar -->
    <aside class="w-full lg:w-80 space-y-5">

      <!-- TEE State -->
      <div class="bg-gray-900 rounded-xl border border-gray-800 p-5">
        <h3 class="font-semibold text-sm mb-3 text-gray-300">TEE State</h3>
        <div id="state-panel" class="text-sm space-y-2">
          <div class="flex justify-between">
            <span class="text-gray-500">Runtime</span>
            <span id="state-runtime" class="text-gray-600">Not booted</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-500">Provider</span>
            <span id="state-provider" class="text-gray-600">&mdash;</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-500">Root Key</span>
            <span id="state-rootkey" class="text-gray-600">Not initialized</span>
          </div>
          <hr class="border-gray-800" />
          <div>
            <span class="text-gray-500 text-xs">Active Keys</span>
            <div id="state-keys" class="mt-1 text-xs text-gray-600">None</div>
          </div>
          <hr class="border-gray-800" />
          <div>
            <span class="text-gray-500 text-xs">Policy Rules</span>
            <div id="state-policy" class="mt-1 text-xs text-gray-600">None</div>
          </div>
        </div>
      </div>

      <!-- How It Works -->
      <div class="bg-gray-900 rounded-xl border border-gray-800 p-5">
        <h3 class="font-semibold text-sm mb-3 text-gray-300">How It Works</h3>
        <div id="how-it-works" class="text-xs space-y-3">
          <div class="flow-step">
            <div class="flow-step-dot" id="flow-dot-1"></div>
            <div>
              <span class="text-gray-300 font-medium">1. Boot Runtime</span>
              <p class="text-gray-500 mt-0.5" id="flow-desc-1">Select a TEE provider and initialize the trusted environment.</p>
            </div>
          </div>
          <div class="flow-step">
            <div class="flow-step-dot" id="flow-dot-2"></div>
            <div>
              <span class="text-gray-300 font-medium">2. Seal Root Key</span>
              <p class="text-gray-500 mt-0.5" id="flow-desc-2">Generate root key &rarr; encrypt with AES-256-GCM &rarr; store sealed in TEE memory.</p>
            </div>
          </div>
          <div class="flow-step">
            <div class="flow-step-dot" id="flow-dot-3"></div>
            <div>
              <span class="text-gray-300 font-medium">3. Derive &amp; Sign</span>
              <p class="text-gray-500 mt-0.5" id="flow-desc-3">HKDF-SHA256 derives child keys. Private keys never leave the TEE boundary.</p>
            </div>
          </div>
          <div class="flow-step">
            <div class="flow-step-dot" id="flow-dot-4"></div>
            <div>
              <span class="text-gray-300 font-medium">4. Enforce Policy</span>
              <p class="text-gray-500 mt-0.5" id="flow-desc-4">All policy rules evaluated inside TEE before any signing operation.</p>
            </div>
          </div>
          <div class="flow-step">
            <div class="flow-step-dot" id="flow-dot-5"></div>
            <div>
              <span class="text-gray-300 font-medium">5. Attest</span>
              <p class="text-gray-500 mt-0.5" id="flow-desc-5">Prove TEE identity and root key binding to external verifiers.</p>
            </div>
          </div>
          <div class="flow-step">
            <div class="flow-step-dot" id="flow-dot-6"></div>
            <div>
              <span class="text-gray-300 font-medium">6. Rotate</span>
              <p class="text-gray-500 mt-0.5" id="flow-desc-6">Increment epoch, derive new key, mark old key as rotated.</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Activity Log -->
      <div class="bg-gray-900 rounded-xl border border-gray-800 p-5">
        <div class="flex justify-between items-center mb-3">
          <h3 class="font-semibold text-sm text-gray-300">Activity Log</h3>
          <button onclick="document.getElementById('log-entries').innerHTML=''" class="text-xs text-gray-600 hover:text-gray-400">Clear</button>
        </div>
        <div id="log-entries" class="space-y-1 max-h-96 overflow-y-auto text-xs font-mono"></div>
      </div>

    </aside>
  </div>

<script>
// --- State ---
let currentKeyId = null;
let currentAddress = null;
let selectedProvider = 'simulator';
let lastQuote = null;

// --- Provider descriptions ---
const providerArchBoot = {
  simulator: `<strong class="text-indigo-300">Simulator internals:</strong><br/>
    <code>SimulatedRuntime</code> creates an in-memory sealing key from <code>SHA256("tee-seal-key:" + measurement)</code>.
    No actual hardware isolation &mdash; useful for development.<br/><br/>
    <span class="text-gray-500">Measurement:</span> Fixed string <code>"akm-poc-v1"</code> (deterministic for testing)`,
  dstack: `<strong class="text-pink-300">dstack (TDX) internals:</strong><br/>
    <code>DstackRuntime</code> connects to the Phala dstack daemon via <code>TappdClient</code>.<br/>
    <span class="text-gray-300">initialize()</span> calls <code>client.info()</code> to verify reachability,
    then <code>client.deriveKey("akm/sealed-storage/v1")</code> to get a TEE-bound sealing key.<br/><br/>
    <span class="text-gray-500">Measurement:</span> <code>tcb_info.mrtd</code> &mdash; real hardware measurement from Intel TDX`
};

const providerArchInit = {
  simulator: `<strong class="text-indigo-300">Sealing:</strong> Root key encrypted with AES-256-GCM using <code>SHA256("tee-seal-key:akm-poc-v1")</code> as the key. IV (12B) + AuthTag (16B) + Ciphertext stored in-memory Map.`,
  dstack: `<strong class="text-pink-300">Sealing:</strong> Root key encrypted with AES-256-GCM using key from <code>TappdClient.deriveKey("akm/sealed-storage/v1").asUint8Array(32)</code>.
    This key is <em>deterministic and bound to TEE identity</em> &mdash; a different enclave cannot derive the same key.`
};

const providerArchAttest = {
  simulator: `<strong class="text-indigo-300">Simulated attestation:</strong><br/>
    Quote signature = <code>SHA256(signingSecret + payload)</code> where <code>signingSecret = "sim-attest-key:" + mrEnclave</code>.<br/>
    Verifier re-computes the same hash to validate. No hardware root of trust.`,
  dstack: `<strong class="text-pink-300">TDX attestation:</strong><br/>
    Quote generated via <code>TappdClient.tdxQuote(reportData, "sha256")</code> which produces a real Intel TDX quote.<br/>
    The quote contains hardware-signed measurements (<code>mrtd</code>, RTMRs) that can be verified against Intel's attestation service.<br/>
    <code>userData</code> = <code>SHA256(nonce + ":" + rootPublicKey)</code> binds the root key to the TEE identity.`
};

// --- Helpers ---
function truncate(s, n = 16) {
  if (!s) return '';
  return s.length > n ? s.slice(0, n) + '...' : s;
}

function showResult(id, html, isError = false) {
  const el = document.getElementById(id);
  el.classList.remove('hidden');
  el.className = el.className.replace(/text-(green|red|amber)-400/g, '');
  el.classList.add(isError ? 'text-red-400' : 'text-green-400');
  el.innerHTML = html;
}

function addLog(msg, type = 'info') {
  const colors = { info: 'text-gray-400', success: 'text-green-400', error: 'text-red-400', warn: 'text-amber-400' };
  const time = new Date().toLocaleTimeString('en-US', { hour12: false });
  const entry = document.createElement('div');
  entry.className = `log-entry ${colors[type] || colors.info}`;
  entry.innerHTML = `<span class="text-gray-600">${time}</span> ${msg}`;
  const log = document.getElementById('log-entries');
  log.prepend(entry);
}

function enableAct(n) {
  document.getElementById('act' + n).classList.remove('disabled');
}

function showArch(id, content) {
  const el = document.getElementById(id);
  if (!el) return;
  el.innerHTML = content;
  el.classList.remove('hidden');
  if (selectedProvider === 'dstack') {
    el.classList.add('arch-note-dstack');
  } else {
    el.classList.remove('arch-note-dstack');
  }
}

function markFlowDone(n) {
  const dot = document.getElementById('flow-dot-' + n);
  if (dot) dot.classList.add('done');
}

async function api(path, body) {
  const opts = body !== undefined
    ? { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) }
    : { method: 'GET' };
  const res = await fetch(path, opts);
  const data = await res.json();
  if (!res.ok || data.error) throw new Error(data.error || `HTTP ${res.status}`);
  return data;
}

async function refreshState() {
  try {
    const s = await api('/api/state');
    document.getElementById('state-runtime').textContent = s.booted ? 'Booted' : 'Not booted';
    document.getElementById('state-runtime').className = s.booted ? 'text-green-400' : 'text-gray-600';
    document.getElementById('state-rootkey').textContent = s.initialized ? 'Initialized' : 'Not initialized';
    document.getElementById('state-rootkey').className = s.initialized ? 'text-green-400' : 'text-gray-600';

    const provEl = document.getElementById('state-provider');
    if (s.provider) {
      provEl.innerHTML = s.provider === 'dstack'
        ? '<span class="badge badge-dstack">dstack</span>'
        : '<span class="badge badge-provider">simulator</span>';
    } else {
      provEl.innerHTML = '&mdash;';
    }

    if (s.keys.length > 0) {
      document.getElementById('state-keys').innerHTML = s.keys.map(k =>
        `<div class="flex justify-between items-center py-0.5">
          <span class="text-gray-300">${k.agentId} <span class="text-gray-600">epoch-${k.epoch}</span></span>
          <span class="badge ${k.status === 'active' ? 'badge-active' : 'badge-rotated'}">${k.status}</span>
        </div>
        <div class="text-gray-500 mb-1">${truncate(k.address, 20)}</div>`
      ).join('');
    } else {
      document.getElementById('state-keys').textContent = 'None';
    }

    if (s.policyRules.length > 0) {
      document.getElementById('state-policy').innerHTML = s.policyRules.map(r =>
        `<div class="text-gray-300 py-0.5">${r.name} <span class="text-gray-600">(${r.type})</span></div>`
      ).join('');
    } else {
      document.getElementById('state-policy').textContent = 'None';
    }
  } catch {}
}

function setLoading(btnId, loading) {
  const btn = document.getElementById(btnId);
  if (!btn) return;
  if (loading) {
    btn.disabled = true;
    btn.dataset.origText = btn.innerHTML;
    btn.innerHTML = '<span class="spinner"></span>';
  } else {
    btn.disabled = false;
    btn.innerHTML = btn.dataset.origText || btn.innerHTML;
  }
}

// --- Provider Selection ---
function selectProvider(provider) {
  selectedProvider = provider;
  const simBtn = document.getElementById('provider-simulator');
  const dstackBtn = document.getElementById('provider-dstack');
  if (provider === 'simulator') {
    simBtn.classList.replace('border-gray-700', 'border-indigo-500');
    dstackBtn.classList.replace('border-pink-500', 'border-gray-700');
    dstackBtn.classList.replace('border-indigo-500', 'border-gray-700');
  } else {
    dstackBtn.classList.replace('border-gray-700', 'border-pink-500');
    simBtn.classList.replace('border-indigo-500', 'border-gray-700');
  }
}

// --- Actions ---

async function bootRuntime() {
  setLoading('btn-boot', true);
  try {
    const data = await api('/api/boot', { provider: selectedProvider });
    const provLabel = selectedProvider === 'dstack' ? 'dstack (TDX)' : 'Simulator';
    showResult('result-boot',
      `&#10003; Runtime booted &mdash; <span class="font-bold">${provLabel}</span><br/>` +
      `Measurement: <span class="text-indigo-300">${data.measurement}</span>`
    );
    addLog(`TEE runtime booted [${provLabel}]`, 'success');
    showArch('arch-boot', providerArchBoot[selectedProvider]);
    markFlowDone(1);
    enableAct(2);
    refreshState();
  } catch (e) {
    let hint = '';
    if (selectedProvider === 'dstack' && (e.message.includes('fetch') || e.message.includes('connect') || e.message.includes('ECONNREFUSED'))) {
      hint = '<br/><span class="text-amber-400 text-xs">Hint: Is the dstack simulator running? Set DSTACK_ENDPOINT env var.</span>';
    }
    showResult('result-boot', `&#10007; ${e.message}${hint}`, true);
    addLog(`Boot failed: ${e.message}`, 'error');
  } finally {
    setLoading('btn-boot', false);
  }
}

async function initRootKey() {
  setLoading('btn-init', true);
  try {
    const data = await api('/api/init', {});
    showResult('result-init', `&#10003; Root key initialized<br/>Public Key: <span class="text-indigo-300">${truncate(data.rootPublicKey, 32)}</span>`);
    addLog('Root key initialized', 'success');
    showArch('arch-init', providerArchInit[selectedProvider]);
    markFlowDone(2);
    enableAct(3);
    refreshState();
  } catch (e) {
    showResult('result-init', `&#10007; ${e.message}`, true);
    addLog(`Init failed: ${e.message}`, 'error');
  } finally {
    setLoading('btn-init', false);
  }
}

async function createKey() {
  setLoading('btn-createKey', true);
  try {
    const agentId = document.getElementById('input-agentId').value || 'dao-agent';
    const data = await api('/api/keys', { agentId });
    currentKeyId = data.keyId;
    currentAddress = data.ethereumAddress;
    showResult('result-createKey',
      `&#10003; Key created<br/>` +
      `Key ID: <span class="text-indigo-300">${data.keyId}</span><br/>` +
      `Address: <span class="text-indigo-300">${data.ethereumAddress}</span>`
    );
    addLog(`Key created for ${agentId}: ${truncate(data.ethereumAddress)}`, 'success');
    document.getElementById('sign-section').classList.remove('hidden');
    markFlowDone(3);
    enableAct(4);
    enableAct(5);
    enableAct(6);
    refreshState();
  } catch (e) {
    showResult('result-createKey', `&#10007; ${e.message}`, true);
    addLog(`Key creation failed: ${e.message}`, 'error');
  } finally {
    setLoading('btn-createKey', false);
  }
}

async function signMessage() {
  try {
    const message = document.getElementById('input-message').value || 'Hello from TEE!';
    const data = await api('/api/sign/message', { keyId: currentKeyId, callerId: 'web-demo', message });
    showResult('result-signMsg',
      `&#10003; Message signed<br/>Signature: <span class="text-indigo-300">${truncate(data.signature, 32)}</span>`
    );
    addLog(`Signed message: "${truncate(message, 20)}"`, 'success');
  } catch (e) {
    showResult('result-signMsg', `&#10007; ${e.message}`, true);
    addLog(`Sign message failed: ${e.message}`, 'error');
  }
}

async function signTransaction() {
  try {
    const value = document.getElementById('input-txValue').value || '0.1';
    const data = await api('/api/sign/transaction', {
      keyId: currentKeyId, callerId: 'web-demo',
      to: '0x0000000000000000000000000000000000000001', value
    });
    showResult('result-signTx',
      `&#10003; Transaction signed<br/>` +
      `Hash: <span class="text-indigo-300">${truncate(data.hash, 32)}</span><br/>` +
      `From: <span class="text-indigo-300">${data.from}</span>`
    );
    addLog(`Signed tx: ${value} ETH`, 'success');
  } catch (e) {
    showResult('result-signTx', `&#10007; ${e.message}`, true);
    addLog(`Sign tx failed: ${e.message}`, 'error');
  }
}

async function setupPolicy() {
  setLoading('btn-policy', true);
  try {
    const allowedCallers = [document.getElementById('input-caller').value || 'web-demo'];
    const maxPerTxEth = document.getElementById('input-maxTx').value || '1';
    const maxPerDayEth = document.getElementById('input-maxDay').value || '5';
    const data = await api('/api/policy/setup', { allowedCallers, maxPerTxEth, maxPerDayEth });
    showResult('result-policy',
      `&#10003; Policy configured<br/>` +
      data.rules.map(r => `<span class="text-indigo-300">${r.name}</span>: ${r.detail}`).join('<br/>')
    );
    addLog(`Policy set: ${data.rules.length} rules`, 'success');
    document.getElementById('policy-tests').classList.remove('hidden');
    markFlowDone(4);
    refreshState();
  } catch (e) {
    showResult('result-policy', `&#10007; ${e.message}`, true);
    addLog(`Policy setup failed: ${e.message}`, 'error');
  } finally {
    setLoading('btn-policy', false);
  }
}

async function testPolicy(ethValue, callerId) {
  try {
    const data = await api('/api/sign/transaction', {
      keyId: currentKeyId, callerId,
      to: '0x0000000000000000000000000000000000000001', value: ethValue
    });
    showResult('result-policyTest',
      `<span class="text-green-400">&#10003; ALLOWED</span> &mdash; ${ethValue} ETH from "${callerId}"<br/>` +
      `Hash: <span class="text-indigo-300">${truncate(data.hash, 32)}</span>`
    );
    addLog(`Policy test: ${ethValue} ETH by ${callerId} - ALLOWED`, 'success');
  } catch (e) {
    showResult('result-policyTest',
      `<span class="text-red-400">&#10007; DENIED</span> &mdash; ${ethValue} ETH from "${callerId}"<br/>` +
      `Reason: <span class="text-amber-400">${e.message}</span>`
    );
    addLog(`Policy test: ${ethValue} ETH by ${callerId} - DENIED`, 'warn');
  }
}

async function generateQuote() {
  setLoading('btn-quote', true);
  try {
    const data = await api('/api/attestation/quote', {});
    lastQuote = data.quote;
    const report = data.quote.report;
    showResult('result-quote',
      `&#10003; Attestation quote generated<br/>` +
      `Provider: <span class="text-indigo-300">${report.provider}</span><br/>` +
      `mrEnclave: <span class="text-indigo-300">${truncate(report.measurements.mrEnclave, 24)}</span><br/>` +
      `mrSigner: <span class="text-indigo-300">${truncate(report.measurements.mrSigner, 24)}</span><br/>` +
      `Nonce: <span class="text-indigo-300">${truncate(data.quote.nonce, 24)}</span><br/>` +
      `Signature: <span class="text-indigo-300">${truncate(report.signature, 32)}</span><br/>` +
      `Root PubKey bound: <span class="text-indigo-300">${truncate(data.quote.rootPublicKey, 24)}</span>`
    );
    addLog('Attestation quote generated', 'success');
    document.getElementById('verify-section').classList.remove('hidden');
    showArch('arch-attest', providerArchAttest[selectedProvider]);
    markFlowDone(5);
  } catch (e) {
    showResult('result-quote', `&#10007; ${e.message}`, true);
    addLog(`Quote generation failed: ${e.message}`, 'error');
  } finally {
    setLoading('btn-quote', false);
  }
}

async function verifyQuote() {
  setLoading('btn-verify', true);
  try {
    const data = await api('/api/attestation/verify', { quote: lastQuote });
    const result = data.result;
    if (result.valid) {
      showResult('result-verify',
        `<span class="text-green-400">&#10003; VALID</span> &mdash; Attestation verified successfully<br/>` +
        `Provider: <span class="text-indigo-300">${result.report.provider}</span><br/>` +
        `Timestamp: <span class="text-indigo-300">${new Date(result.report.timestamp).toLocaleTimeString()}</span>`
      );
      addLog('Attestation verified: VALID', 'success');
    } else {
      showResult('result-verify',
        `<span class="text-red-400">&#10007; INVALID</span><br/>` +
        `Reason: <span class="text-amber-400">${result.reason}</span>`,
        true
      );
      addLog(`Attestation invalid: ${result.reason}`, 'error');
    }
  } catch (e) {
    showResult('result-verify', `&#10007; ${e.message}`, true);
    addLog(`Verification failed: ${e.message}`, 'error');
  } finally {
    setLoading('btn-verify', false);
  }
}

async function rotateKey() {
  setLoading('btn-rotate', true);
  try {
    const data = await api('/api/keys/rotate', { keyId: currentKeyId });
    currentKeyId = data.newKey.keyId;
    currentAddress = data.newKey.address;
    showResult('result-rotate',
      `&#10003; Key rotated<br/>` +
      `Old: <span class="text-gray-500">${data.oldKey.keyId}</span> <span class="badge badge-rotated">${data.oldKey.status}</span><br/>` +
      `New: <span class="text-indigo-300">${data.newKey.keyId}</span> (epoch-${data.newKey.epoch})<br/>` +
      `Address: <span class="text-indigo-300">${data.newKey.address}</span>`
    );
    addLog(`Key rotated to epoch-${data.newKey.epoch}`, 'success');
    markFlowDone(6);
    refreshState();
  } catch (e) {
    showResult('result-rotate', `&#10007; ${e.message}`, true);
    addLog(`Rotation failed: ${e.message}`, 'error');
  } finally {
    setLoading('btn-rotate', false);
  }
}

// Initial state
selectProvider('simulator');
setInterval(refreshState, 3000);
refreshState();
</script>

</body>
</html>
